# 以太坊ERC20代币账户指数计算说明

## 什么是账户指数
账户指数（Account Rank，简称AR）是ASResearch研究团队提出的，以流动性、传播性、互操作性等体现数据互动关系的因素为基础的，用于衡量和描述以太坊主网上的地址、智能合约、去中心化应用等对象的影响力的一个统计指标。账户指数通过对链上数据进行综合统计并排序后，能够体现区块链地址（对象）在整个网络中的重要程度。

## 为什么使用账户指数
就目前而言，大部分区块链项目都选择以用户的资产质押或者利用PageRank算法作为衡量用户重要性的价值指标。然而这两种方式本身存在着一定的缺陷：

- 1）资产质押的方式会导致用户为了保证自身权益而锁定资产，降低资产的流动性；

- 2）PageRank算法在区块链网络中无法有效抵抗女巫攻击。

ASResearch研究团队提出的账户指数（AR）是一个综合考量区块链上数据的，兼顾用户地址资产保有量以及资产流动性的用户地址价值衡量指标。利用独创的Wilbur函数f来计算账户指数，使其满足：

- a）f(x+y) > f(x) + f(y)，严格抵抗女巫攻击；

- b）limx, y → ∞, f(x+y) = f(x) + f(y)，避免资产大户的绝对统治，促进资产流通。

## 账户指数（AR）计算公式

 <div style="text-align:center"> <img src="https://github.com/Niko-Guan/AR/blob/master/pic/fomular.png" title="fomular" /> </div>

- 参数说明：

> 1）M：统计时间段内某地址的ERC20资产中值占比。对地址的balance按照每128个区块高度的间隔进行采样，并选出中位数作为地址的ERC20资产中值，再除以该代币的现时流通总量获得比值。
> 
>> a）a：Wilbur函数f中资产中值的权重阈值。当资产中值占比M低于该阈值时，随着M的降低，其对账户指数的影响权重会越来越低（大于等于0）；大于该阈值时，随着M的增加，其权重会越来越高（小于等于1）。该阈值在一定程度上限制了用户资产的最低保有量，提高了实现女巫攻击的成本。当前，θ取值为0.0002%，即当资产中值占代币总流通量的比值低于0.0002%时，其对账户指数的影响随着资产中值的减少而降低，而高于0.0002%，则影响会随着资产中值的增加而提高。
>>
>> b）b：用于调整资产中值权重的变化程度，取值范围为（0,1）。b越大，资产中值权重变化越快，反之越慢。当前b取值为0.5。
>>
>
> 2）R：统计时间段内某地址的出入度指标。该计算公式天然地反映了该地址对资产流动的价值，即在出度O和入度I总和相同的情况下，地址的出度O和入度I越接近，其价值就越高；而对于一些只有出度O或者只有入度I的地址，也对资产流动有一定的价值，并且这两种情况都是有界的，其价值差距为e倍。
> 
>> a）I：统计时间段内某地址ERC20资产流入占比。对在统计时间段内的流向某一地址的资产进行求和，再除以该代币的现时流通总量获得比值。
>>
>> b）O：统计时间段内某地址ERC20资产流出占比。对在统计时间段内的从某一地址流出的资产进行求和，再除以该代币的现时流通总量获得比值。
>>
>> c）p：最低限度因子。取值在[0,1]之间，通过加入资产中值因素来作为出入度指标的最低保有量，以减少数据异常波动时带来的影响。当前，p取0.1，在作为出入度指标的最低保有量的同时，不至于为出入度指标带来过量的影响。
>>
>> d）α：当前取值为-2，用于控制R的上下界差距为e倍。
>> 
>> e）β：当前取值为π/4，用于控制R的上下界差距为e倍。
>>
>
> 备注：
> 
> 1）所有参数计算均是针对单一种ERC20代币以及某一个具体的地址；
> 
> 2）I和O进行计算之前已经过去环处理。
>
> 3）由于M，I，O和θ数值很小（代币的现时流通总量在10^6到10^12个代币单位之间），因此，在计算过程中对这些数据进行了放大，放大倍数为10万倍。
>

<br>

## 账户指数（AR）统计流程

账户指数（AR）的统计过程如下：

&emsp;&emsp;（1）收集在统计时间段内以太坊主网上发生的所有交易，并筛选出用户地址调用ERC20代币合约进行转账的交易作为统计交易集，筛选方式为：检查交易的data属性，以“0xa9059cbb”（ERC20合约中transfer函数的编码）为开头的交易即为进行代币转账的交易；

&emsp;&emsp;（2）从统计样本的所有交易中找出涉及到的所有用户地址（包括流出地址和流入地址），作为统计对象集，其中，流出地址是交易中的FROM属性项，流入地址通过检查交易的data属性，截取data字段的第34个字符到第74个字符即为流入地址（调用transfer函数，标准data字段长度为138个字符，前10个字符是函数名编码，10—74共64个字符长度为address参数，其中用户地址长度为40字符，参数长度不足时会自动在参数前方补0，故34—74为地址，而74—138则是转账金额）；

&emsp;&emsp;（3）对（2）中采集到的用户地址，求解其在统计时间段的起始区块时的ERC20代币余额（balance）。在获得交易集后，可以从height属性中获得区块高度范围，然后通过API调用ERC20合约提供的函数balance（函数编码“0x70a08231”）可以获得该地址在起始区块高度上的余额。

&emsp;&emsp;（4）求解地址ERC20资产中值占比。根据（3）中获得的余额数据以及（1）中的交易集，按照128个区块高度进行分组，分组后，对该区块间隔内的所有交易进行重新验算，根据交易的status属性（表示交易是否成功），来对流出地址和流入地址的余额balance进行增加或减少（如果交易成功，流出地址余额减少，流入地址余额增加），验算完成后地址的余额balance作为该地址的样本点；直到所有的分组都验算完成后，流出地址和流入地址都得出一系列的样本点，然后再对每一个地址的样本集，取中位数后再除以该ERC20代币现时总流通量，作为该地址在统计时间段内的资产中值占比。

&emsp;&emsp;（5）求解地址ERC20资产出入度占比。从（1）的交易集中筛选出所有交易成功（status=1）的交易，并用这些交易构造地址转账图。对转账图进行去环和整合后，得到每个地址的流入和流出ERC20代币量，再分别除以该代币的现时流通量，得到该地址的ERC20出度占比和入度占比。

&emsp;&emsp;（6）根据（4）和（5）中得到的数据集，以地址为单位，分别将每个地址对应的资产中值占比和出入度占比数据代入账户指数（AR）公式求解该地址在统计时间段内的账户指数。

&emsp;&emsp;（7）计算完成后，分别进行以下两项数据统计：

&emsp;&emsp;&emsp;&emsp; a）以ERC20代币为单位，求在统计时间内所有使用该代币进行转账的用户的账户指数之和，以此作为该代币的活跃度指数。

&emsp;&emsp;&emsp;&emsp; b）以单一地址为单位，求在统计时间内该地址所有进行过转账交易的ERC20代币的账户指数（AR）之和，作为该用户的活跃度指数。

## 统计结果

我们设定统计的时间段为2019年10月28日至2019年10月31日，针对CoinMarketCap网站Top Cryptocurrencies 榜单上前100名的加密货币中的ERC20代币进行统计，统计的代币数量有44个，涉及用户地址131140个，最终的统计结果如下图：

 <div style="text-align:center"> <img src="https://github.com/Niko-Guan/AR/blob/master/pic/ERC20_result.png" title="ERC20 result" /> </div>

 <p style="text-align:center"> 图1 ERC20代币活跃度排名 </p>

 <br>

 <div style="text-align:center"> <img src="https://github.com/Niko-Guan/AR/blob/master/pic/account_result.png" title="account result" /> </div>

 <p style="text-align:center"> 图2 用户活跃度排名（top50）</p>

 <br>

以USDT、USDC、DAI和PAX等为代表的对标美元的稳定币项目，其主要目的是作为区块链中的“美元”来进行实际的商品交易，取代现有的现金支付或者电子支付方式，成为新型的区块链环境下的通用货币。因此，这些代币具有价值稳定、交易频繁、流动性强、用户群体大、散布范围广等特点。因此，这类以流通和交易为主要目的的“电子现金”项目的活跃度应该是最高的。

而类似于LINK、BAT、XMX等具有除流通以外的特定功能的ERC20代币项目中，往往存在服务提供者和服务需求者两种角色，因此，没有服务需求的普通节点一般不会持有这些项目的代币，而且服务需求者会在使用服务的过程中消耗完所持有代币，服务提供者则因为提供服务而持有大量的代币，从而导致这些项目的用户群体集中、散布范围小；同时，这类项目往往在有服务需求的时候才会产生代币的交易，且交易一般会涉及大量持有代币的节点，如服务需求者向基金会或交易所购买代币来使用服务，或者服务提供者向基金会或交易所出售代币以换取现金等。因此，相对于以流通为主要目的的稳定币项目，这类项目的代币的流动性相对较弱，交易频次低，但每次交易产生的账户指数较高，资金大户的影响力很大。

通过对比USDT和XMX两种ERC20代币的账户指数top10的地址的账户指数（图3）更能证明上述结论。

 <div style="text-align:center"> <img src="https://github.com/Niko-Guan/AR/blob/master/pic/USDT-XMX.png" title="account result" /> </div>

 <p style="text-align:center"> 图3 USDT与XMX账户指数对比（top10）</p>

 <br>

然而，通过观察图1，流动性强、散布范围广的稳定币项目的活跃度统计结果均比具有服务功能的代币项目的活跃度高，这样的结果比较符合市场的规律，同时证明了账户指数（AR）模型一定程度上能够避免资金大户的绝对统治。

根据公式设计和统计流程可知，如果想通过女巫攻击来提高用户地址的账户指数，该用户需要在保有一定量的数字资产的情况下，进行大量的代币流转才可以实现。而在统计流程中，我们对用户的转账行为进行了去环处理，防止用户通过来回转账的方式提高代币流转量，这意味着用户必须伪造大量的、持有一定量数字资产的地址并进行较大额度的转账，才可能实现女巫攻击，这使得实现女巫攻击的成本大大提高。